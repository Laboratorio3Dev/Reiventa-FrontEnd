@page "{p:int?}"
@model PlanAccionModel
@{
    ViewData["Title"] = "Plan de Acción";
}

<!-- FILTROS -->
<div class="filters">
    <div class="filters-header">🔍 Filtros de búsqueda</div>

    <div class="filters-grid">
        <div>
            <label>Colaborador</label>
            <select class="form-control" id="fColaborador">
                <option value="">Todos</option>
                @foreach (var item in Model.ListaColaboradores)
                {
                    <option value="@item">@item</option>
                }
            </select>
        </div>
        <div>
            <label>Producto</label>
            <select class="form-control" id="fProducto">
                <option value="">Todos</option>
                @foreach (var item in Model.ListaProductos)
                {
                    <option value="@item">@item</option>
                }
            </select>
        </div>
        <div>
            <label>Oficina</label>
            <select class="form-control" id="fOficina">
                <option value="">Todos</option>
                @foreach (var item in Model.ListaOficinas)
                {
                    <option value="@item">@item</option>
                }
            </select>
        </div>
        <div>
            <label>Zona</label>
            <select class="form-control" id="fZona">
                <option value="">Todos</option>
                @foreach (var item in Model.ListaZonas)
                {
                    <option value="@item">@item</option>
                }
            </select>
        </div>
        <div>
            <label>Gerente</label>
            <select class="form-control" id="fGerente">
                <option value="">Todos</option>
                @foreach (var item in Model.ListaGerentes)
                {
                    <option value="@item">@item</option>
                }
            </select>
        </div>

        <div class="filter-actions">
            <button class="btn btn-primary w-100 mb-1" onclick="aplicarFiltros()">
                🔎 Filtrar
            </button>
            <form method="post" asp-page-handler="ExportarExcel">
                <button class="btn btn-success">
                    📊 Exportar a Excel
                </button>
            </form>
            @if (HttpContext.Session.GetString("Rol") == "EsGO")
            {
                <button class="btn btn-primary w-100 mb-3"
                        data-bs-toggle="modal"
                        data-bs-target="#modalAsignarTarea">
                    Asignar Tareas
                </button>
            }
        </div>
    </div>
</div>


<!-- MODAL ASIGNAR TAREA -->
<div class="modal fade" id="modalAsignarTarea" tabindex="-1" aria-labelledby="modalAsignarTareaTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <form method="post" asp-page-handler="AsignarTarea">
            <div class="modal-content">

                <!-- Header -->
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalAsignarTareaTitle">Asignar tarea</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- Body -->
                <div class="modal-body">
                    <div class="row">

                        <!-- Colaborador -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Colaborador</label>
                            <select class="form-select" name="colaboradorId">
                                <option value="">Seleccione</option>
                                @foreach (var item in Model.Colaboradores)
                                {
                                    <option value="@item.Id">@item.Valor</option>
                                }
                            </select>
                        </div>

                        <!-- Producto -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Producto</label>
                            <select class="form-select" name="productoId" id="productoSelect" onchange="filtrarTareas()">
                                <option value="">Seleccione</option>
                                @foreach (var item in Model.Productos)
                                {
                                    <option value="@item.Id">@item.Valor</option>

                                }
                            </select>
                        </div>

                    </div>

                    <div class="row">
                        <!-- Dimensión -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Dimensión</label>
                            <select class="form-select" name="dimensionId" id="dimensionSelect" onchange="filtrarTareas()">
                                <option value="">Seleccione</option>
                                @foreach (var item in Model.Dimensiones)
                                {
                                    <option value="@item.Id">@item.Valor</option>

                                    
                                }
                            </select>
                        </div>
                    </div>

                    <!-- Lista de Tareas -->
                    <h6 class="text-start">Seleccione una tarea</h6>
                    <div class="list-group" id="listaTareas">
                        @if (Model.PopupTareas != null && Model.PopupTareas.Any())
                        {
                            @foreach (var tarea in Model.PopupTareas)
                            {
                                <button type="button" class="list-group-item list-group-item-action text-start" 
                                        data-id="@tarea.ID_TAREA">
                                    @tarea.TAREA
                                </button>
                            }
                        }
                        else
                        {
                            <div class="text-muted">No hay tareas para mostrar.</div>
                        }
                    </div>

                    <!-- Input oculto para tarea seleccionada -->
                    <input type="hidden" id="tareaId" name="tareaId" />

                    <!-- Fecha Límite -->
                    <div class="mt-3">
                        <label>Fecha Límite</label>
                        <input type="date" name="fechaLimite" class="form-control" />
                    </div>
                </div>

                <!-- Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="agregarAlResumen()">
                        Agregar a lista
                    </button>
                </div>

            </div>
        </form>
    </div>
</div>


<!-- RESUMEN -->
<div class="summary">
    <div class="summary-card bg-total"><span>@Model.Total</span>Total</div>
    <div class="summary-card bg-no"><span>@Model.NoIniciadas</span>No iniciadas</div>
    <div class="summary-card bg-proceso"><span>@Model.EnProceso</span>En proceso</div>
    <div class="summary-card bg-atrasada"><span>@Model.Atrasadas</span>Atrasada</div>
    <div class="summary-card bg-observada"><span>@Model.Observadas</span>Observada</div>
    <div class="summary-card bg-revision"><span>@Model.RevisionGO</span>Revisión GO</div>
    <div class="summary-card bg-ok"><span>@Model.Completadas</span>Completada</div>
</div>




<div class="table-view">
    <div class="table-responsive-custom">
        <table class="custom-table">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Dimensión</th>
                    <th>Tarea</th>
                    <th>Usuario</th>
                    <th>Oficina</th>
                    <th>Zona</th>
                    <th>Gerente</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Planes)
                {
                    <tr>
                        <td>@item.PRODUCTO</td>
                        <td>@item.DIMENSION</td>
                        <td>@item.TAREA</td>
                        <td>@item.USUARIO</td>
                        <td>@item.Oficina</td>
                        <td>@item.Zona</td>
                        <td>@item.GerenteOficina</td>
                        <td>@item.FECHA</td>
                        <td>
                            <span class="badge @item.EstadoCss">
                                @item.ESTADO
                            </span>
                        </td>
                        <td>
                            @if (HttpContext.Session.GetString("Rol") == "EsEjecutivo" && item.ESTADO == "No Iniciada")
                            {
                                <button class="action-btn btn-iniciar"
                                        data-bs-toggle="modal"
                                        data-bs-target="#modalIniciar"
                                        data-id="@item.ID_PLANACCION">
                                    <i class="bi bi-play-circle"></i> Iniciar
                                </button>

                            }

                            @if (HttpContext.Session.GetString("Rol") == "EsEjecutivo" &&
                                                    (item.ESTADO == "En Proceso" || item.ESTADO == "Observada"))
                            {
                              @*   <button class="action-btn btn-revisar"
                                        data-bs-toggle="modal"
                                        data-bs-target="#modalRevisar"
                                        data-id="@item.ID_PLANACCION">
                                    <i class="bi bi-eye"></i> Revisar
                                </button> *@
                                <button class="action-btn btn-revisar"
                                        data-bs-toggle="modal"
                                        data-bs-target="#modalGO"
                                        data-id="@item.ID_PLANACCION"
                                        data-producto="@item.PRODUCTO"
                                        data-dimension="@item.DIMENSION"
                                        data-comentario="@item.Comentario"
                                        data-tarea="@item.TAREA"
                                        data-fecha="@item.FECHA"
                                        data-usuario="@item.USUARIO">
                                    <i class="bi bi-eye"></i> Revisar
                                </button>
                            }

                            @if (HttpContext.Session.GetString("Rol") == "EsGO" && item.ESTADO == "Revisión GO")
                            {
                                <button class="action-btn btn-go"
                                        data-bs-toggle="modal"
                                        data-bs-target="#modalGO"
                                        data-id="@item.ID_PLANACCION"
                                        data-producto="@item.PRODUCTO"
                                        data-dimension="@item.DIMENSION"
                                        data-comentario="@item.Comentario"                               
                                        data-tarea="@item.TAREA"
                                        data-fecha="@item.FECHA"
                                        data-tiene-evidencia="@(item.Evidencia != null ? "1" : "0")"
                                        data-usuario="@item.USUARIO">
                                    <i class="bi bi-check2-square"></i> Revisar
                                </button>
                            }

                        </td>

                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
<div class="card-view">
    @foreach (var item in Model.Planes)
    {
        <div class="plan-card">
            <div class="card-header">
                <strong>@item.PRODUCTO</strong>
                <span class="badge @item.EstadoCss">
                    @item.ESTADO
                </span>
            </div>

            <div class="card-body">
                <p><b>Dimensión:</b> @item.DIMENSION</p>
                <p><b>Tarea:</b> @item.TAREA</p>
                <p><b>Usuario:</b> @item.USUARIO</p>
                <p><b>Oficina:</b> @item.Oficina</p>
                <p><b>Zona:</b> @item.Zona</p>
                <p><b>Gerente:</b> @item.GerenteOficina</p>
                <p><b>Fecha:</b> @item.FECHA</p>
            </div>
            <div class="plan-card">
                <div class="plan-header">
                    <span class="badge @item.EstadoCss">@item.ESTADO</span>
                </div>

                <h6>@item.TAREA</h6>
                <p class="text-muted">@item.PRODUCTO · @item.DIMENSION</p>

                <div class="mt-2">
                    <!-- reutilizamos EXACTAMENTE la misma lógica -->
                    @* Copias el bloque de botones de arriba *@
                </div>
            </div>

        </div>
    }
</div>


<div class="modal fade" id="modalResumenAsignaciones" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Resumen de asignaciones</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body">
                <div id="resumenAsignacionesContainer">
                    <!-- Aquí se agregarán las tarjetas dinámicamente -->
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="volverAAsignar()">
                    Regresar
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarTodasLasAsignaciones()">
                    Asignar Tareas
                </button>
            </div>

        </div>
    </div>
</div>


<div class="pagination-container">
    <span>
        Mostrando
        @((Model.Page - 1) * Model.PageSize + 1)
        –
        @(Math.Min(Model.Page * Model.PageSize, Model.TotalRegistros))
        de @Model.TotalRegistros
    </span>

    <div class="pagination">

        <a asp-route-p="@(Model.Page - 1)"
           class="page-btn @(Model.Page == 1 ? "disabled" : "")">«</a>

        @for (int i = 1; i <= Model.TotalPaginas; i++)
        {
            <a asp-route-p="@i"
               class="page-btn @(i == Model.Page ? "active" : "")">
                @i
            </a>
        }

        <a asp-route-p="@(Model.Page + 1)"
           class="page-btn @(Model.Page == Model.TotalPaginas ? "disabled" : "")">»</a>

    </div>
</div>


<div class="modal fade" id="modalIniciar" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">

        <form method="post" asp-page-handler="IniciarPlan">
            <div class="modal-content">

                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Iniciar Plan de Acción</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <p>¿Deseas iniciar este plan de acción?</p>

                    <!-- ESTE NAME ES CORRECTO -->
                    <input type="hidden"
                           name="NuevoPlan.ID_PLANACCION"
                           id="planIdIniciar" />
                </div>

                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal">
                        Cancelar
                    </button>

                    <button type="submit"
                            class="btn btn-success">
                        Confirmar
                    </button>
                </div>

            </div>
        </form>

    </div>
</div>



<div class="modal fade" id="modalRevisar" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Revisión de Evidencia</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <textarea class="form-control" rows="4"
                          placeholder="Agregar comentario..."></textarea>
            </div>

            <div class="modal-footer">
                <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button class="btn btn-primary">Enviar</button>
            </div>

        </div>
    </div>
</div>




<!-- Reutilizamos el modalGO con ID modalRevisar para tu botón -->
<div class="modal fade" id="modalGO" tabindex="-1" aria-labelledby="modalGOTitle" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <!-- enctype es vital para subir archivos -->
        <form method="post" enctype="multipart/form-data">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalGOTitle">Gestión de Tarea</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <!-- Campo oculto para el ID -->
                    <input type="hidden" name="NuevoPlan.ID_PLANACCION" id="modalIdPlanAccionGO" />

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Producto:</strong> <span id="modalProductoGO"></span></p>
                            <p><strong>Dimensión:</strong> <span id="modalDimensionGO"></span></p>
                        </div>
                        <div class="col-md-6 text-end">
                            <p><strong>Fecha:</strong> <span id="modalFechaGO"></span></p>
                            <p><strong>Usuario:</strong> <span id="modalUsuarioGO"></span></p>
                        </div>
                    </div>

                    <p><strong>Tarea:</strong></p>
                    <div class="p-2 bg-light border rounded mb-3" id="modalTareaGO"></div>

                    <hr>

                    <div class="mb-3">
                        <label class="form-label"><strong>Evidencia / Comentario:</strong></label>
                        <textarea name="NuevoPlan.Comentario" id="comentarioGO" class="form-control" rows="4" required></textarea>
                        <div id="contenedorEvidenciaGO" class="mt-3"></div>
                    </div>

                    <!-- Solo se muestra el input de archivo si el rol es Ejecutivo -->
                    @if (HttpContext.Session.GetString("Rol") == "EsEjecutivo")
                    {
                        <div class="mb-3">
                            <label class="form-label"><strong>Adjuntar Evidencia:</strong></label>
                            <input type="file" name="ArchivoEvidencia" class="form-control" />
                        </div>
                    }
                </div>

                <div class="modal-footer">
                    @if (HttpContext.Session.GetString("Rol") == "EsGO")
                    {
                        <button type="button" class="btn btn-danger"
                                onclick="abrirObservacion()">
                            ® Observar
                        </button>
                        <button type="submit" asp-page-handler="EnviarGo" class="btn btn-primary">Completar Revisión</button>
                    }
                    else
                    {
                        <button type="submit" asp-page-handler="GuardarGestion" class="btn btn-primary">Guardar Gestión</button>
                    }
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="modalObservarGO" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form method="post" asp-page-handler="Observar">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Observar Plan de Acción</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- ID oculto para saber qué plan observar -->
                    <input type="hidden" name="NuevoPlan.ID_PLANACCION" id="modalIdObservar" />

                    <div class="mb-3">
                        <label class="form-label"><strong>Nueva Fecha de Compromiso:</strong></label>
                        <!-- Usamos type="date" para el selector nativo 2025 -->
                        <input type="date" name="NuevoPlan.FECHA" id="modalFechaObservar" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><strong>Comentario de Observación:</strong></label>
                        <textarea name="NuevoPlan.Comentario" class="form-control" rows="4"
                                  placeholder="Indique el motivo de la observación..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Confirmar Observación</button>
                </div>
            </div>
        </form>
    </div>
</div>


@if (TempData["MensajeExito"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <strong>¡Éxito!</strong> @TempData["MensajeExito"]
        <!-- Se cambió data-bs-dismiss="toast" por "alert" -->
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@Html.AntiForgeryToken()
<script>
            document.addEventListener('DOMContentLoaded', function () {
        const modalGO = document.getElementById('modalGO');
        if (modalGO) {
            
            modalGO.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget; // Botón que abrió el modal

                // Mapeo de datos desde data-* atributos
                const id = button.getAttribute('data-id');
                const producto = button.getAttribute('data-producto');
                const dimension = button.getAttribute('data-dimension');
                const tarea = button.getAttribute('data-tarea');
                const fecha = button.getAttribute('data-fecha');
                const usuario = button.getAttribute('data-usuario');
                const tieneEvidencia = button.getAttribute('data-tiene-evidencia');
                const comentarioPrevio = button.getAttribute('data-comentario');

                // Asignación segura a los elementos del modal
                document.getElementById('modalIdPlanAccionGO').value = id;
                document.getElementById('modalProductoGO').textContent = producto || '';
                document.getElementById('modalDimensionGO').textContent = dimension || '';
                document.getElementById('modalTareaGO').textContent = tarea || '';
                document.getElementById('modalFechaGO').textContent = fecha || '';
                document.getElementById('modalUsuarioGO').textContent = usuario || '';
                
                // Si hay un comentario previo (ej. observación), ponerlo en el textarea
                document.getElementById('comentarioGO').value = comentarioPrevio || '';

                 const contenedor = document.getElementById('contenedorEvidenciaGO');

                if (tieneEvidencia === "1") {
                    contenedor.innerHTML = `
                        <div class="alert alert-info">
                            <strong>Evidencia adjunta:</strong><br>
                            <a class="btn btn-outline-primary btn-sm mt-2"
                               href="?handler=DescargarEvidencia&idPlanAccion=${id}">
                                Descargar evidencia
                            </a>
                        </div>
                    `;
                } else {
                    contenedor.innerHTML = `
                        <div class="text-muted">
                            No se adjuntó evidencia.
                        </div>
                    `;
                }

            });
        }
    });

        function abrirObservacion() {
        // 1. Obtener el ID del modal principal
        const id = document.getElementById('modalIdPlanAccionGO').value;

        // 2. Asignar el ID al modal de observación
        document.getElementById('modalIdObservar').value = id;

        // 3. Pre-cargar la fecha de hoy por defecto (formato YYYY-MM-DD para input date)
        const hoy = new Date().toISOString().split('T')[0];
        document.getElementById('modalFechaObservar').value = hoy;

        // 4. Cerrar modal principal y abrir el de observación
        bootstrap.Modal.getInstance(document.getElementById('modalGO')).hide();
        const modalObs = new bootstrap.Modal(document.getElementById('modalObservarGO'));
        modalObs.show();
    }


    @* document.addEventListener('DOMContentLoaded', function () {
        // Leemos el valor de TempData usando Razor
        var mensaje = '@TempData["MensajeExito"]';

        if (mensaje && mensaje.length > 0) {
            Swal.fire({
                title: '¡Éxito!',
                text: mensaje,
                icon: 'success',
                confirmButtonText: 'Aceptar',
                confirmButtonColor: '#3085d6',
                timer: 3000, // Se cierra solo en 3 segundos
                timerProgressBar: true
            });
        } 
    });*@

        document.addEventListener('DOMContentLoaded', function () {
        const modalIniciar = document.getElementById('modalIniciar');
        if (modalIniciar) {
            modalIniciar.addEventListener('show.bs.modal', function (event) {
                // Botón que activó el modal
                const button = event.relatedTarget;
                // Extraer el ID del atributo data-id
                const id = button.getAttribute('data-id');
                // Asignar al input hidden del modal
                document.getElementById('planIdIniciar').value = id;
            });
        }
    });

        function aplicarFiltros() {
        const col = document.getElementById('fColaborador').value.toLowerCase();
        const prod = document.getElementById('fProducto').value.toLowerCase();
        const ofi = document.getElementById('fOficina').value.toLowerCase();

        const filas = document.querySelectorAll('.custom-table tbody tr');

        filas.forEach(fila => {
            const textoFila = fila.innerText.toLowerCase();
            // Lógica simple: si la fila contiene los términos seleccionados
            const coincide = (col === "" || textoFila.includes(col)) &&
                             (prod === "" || textoFila.includes(prod)) &&
                             (ofi === "" || textoFila.includes(ofi));

            fila.style.display = coincide ? "" : "none";
        });
    }

     document.addEventListener('DOMContentLoaded', function () {
            var mostrarModal = @Json.Serialize(Model.MostrarModal);
            if (mostrarModal === true) {
                var myModal = new bootstrap.Modal(document.getElementById('modalAsignarTarea'));
                myModal.show();
            }
        });

           async function filtrarTareas() {
        const productoId = document.getElementById('productoSelect').value;
        const dimensionId = document.getElementById('dimensionSelect').value;

       const url = `@Url.Page("PlanAccion", null, new { handler = "FiltrarAjax" }, null)&productoId=${productoId}&dimensionId=${dimensionId}`;

        console.log(url);

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Error al obtener tareas');

            const tareas = await response.json();
            const listaTareas = document.getElementById('listaTareas');
            listaTareas.innerHTML = '';

            if (!tareas || tareas.length === 0) {
                listaTareas.innerHTML = '<div class="text-muted">No hay tareas para mostrar.</div>';
                document.getElementById('tareaId').value = '';
                return;
            }

            tareas.forEach(t => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'list-group-item list-group-item-action text-start';
                btn.dataset.id = t.id;
                btn.textContent = t.nombre;

                btn.addEventListener('click', () => {
                    // Quitar clase active de todos
                    document.querySelectorAll('#listaTareas button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // Guardar tarea seleccionada en input hidden
                    document.getElementById('tareaId').value = t.id;
                });

                listaTareas.appendChild(btn);
            });

        } catch (error) {
            console.error(error);
            alert('Error al filtrar tareas');
        }
    }

    // Activar selección inicial de tareas si hay PopupTareas
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('#listaTareas button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('#listaTareas button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('tareaId').value = btn.dataset.id;
            });
        });
    });

           let resumenAsignaciones = [];

    function agregarAlResumen() {

        const colSel = document.querySelector('[name="colaboradorId"]');
        const prodSel = document.getElementById('productoSelect');
        const dimSel  = document.getElementById('dimensionSelect');
        const tareaId = document.getElementById('tareaId').value;
        const fechaInput = document.querySelector('[name="fechaLimite"]');
        const fecha = fechaInput.value;

        if (!fecha) {
            alert('Debe seleccionar una fecha límite');
            return;
        }
       

        if (!colSel.value || !prodSel.value || !dimSel.value || !tareaId) {
            alert('Debe seleccionar Colaborador, Producto, Dimensión y Tarea');
            return;
        }

        const asignacion = {
            colaboradorId: colSel.value,
            colaborador: colSel.options[colSel.selectedIndex].text,
            productoId: prodSel.value,
            producto: prodSel.options[prodSel.selectedIndex].text,
            dimensionId: dimSel.value,
            dimension: dimSel.options[dimSel.selectedIndex].text,
            tareaId: tareaId,
            tarea: document.querySelector('#listaTareas .active').textContent,
            fecha: fecha
        };

        // ❌ evitar duplicados
        if (resumenAsignaciones.some(a =>
            a.colaboradorId === asignacion.colaboradorId &&
            a.tareaId === asignacion.tareaId)) {
            alert('Esta tarea ya fue agregada para este colaborador');
            return;
        }

        resumenAsignaciones.push(asignacion);

        actualizarResumenUI();

        // cerrar modal actual y abrir resumen
        bootstrap.Modal.getInstance(document.getElementById('modalAsignarTarea')).hide();
        new bootstrap.Modal(document.getElementById('modalResumenAsignaciones')).show();
    }

        function actualizarResumenUI() {

        const container = document.getElementById('resumenAsignacionesContainer');
        container.innerHTML = '';

        resumenAsignaciones.forEach((a, index) => {

            const card = document.createElement('div');
            card.className = 'card mb-2';

            card.innerHTML = `
                <div class="card-body d-flex justify-content-between">
                    <div>
                        <strong>${a.colaborador}</strong><br>
                        ${a.producto} · ${a.dimension}<br>
                          <small>
                            ${a.tarea}<br>
                            <strong>Fecha límite:</strong> ${formatearFecha(a.fecha)}
                        </small>
                    </div>
                    <button class="btn btn-sm btn-danger">Eliminar</button>
                </div>
            `;

            card.querySelector('button').addEventListener('click', () => {
                eliminarAsignacion(index);
            });

            container.appendChild(card);
        });
    }
        function formatearFecha(fecha) {
        if (!fecha) return '';
        const [y, m, d] = fecha.split('-');
        return `${d}/${m}/${y}`;
    }

    function eliminarAsignacion(index) {
        resumenAsignaciones.splice(index, 1);
        actualizarResumenUI();
    }

        document.getElementById('modalResumenAsignaciones')
        .addEventListener('hidden.bs.modal', function () {

            // Abrir modal Asignar Tarea cuando se cierra el resumen
            const modalAsignar = new bootstrap.Modal(
                document.getElementById('modalAsignarTarea')
            );
            modalAsignar.show();
    });
        function volverAAsignar() {
        const modalResumen = bootstrap.Modal.getInstance(
            document.getElementById('modalResumenAsignaciones')
        );
        modalResumen.hide(); // disparará hidden.bs.modal
    }
        function guardarTodasLasAsignaciones() {

        if (resumenAsignaciones.length === 0) {
            alert('No hay tareas para asignar');
            return;
        }

        const token = document.querySelector(
            'input[name="__RequestVerificationToken"]'
        ).value;

        // 🔥 MAPEO EXACTO AL DTO
        const payload = resumenAsignaciones.map(a => ({
            Id_Tarea: a.tareaId,
            Usuario: parseInt(a.colaboradorId),   // ✅ INT
            FechaTarea: a.fecha || null            // ✅ DateTime?
        }));

        fetch('?handler=GuardarAsignaciones', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': token
            },
            body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                alert(data.message);
                return;
            }
            window.location.reload();
        })
        .catch(err => {
            console.error(err);
            alert('Error inesperado');
        });
    }

        document.querySelector('form[asp-page-handler="ExportarExcel"]')
        ?.addEventListener('submit', function () {

            document.getElementById('hfColaborador').value =
                document.getElementById('fColaborador').value;

            document.getElementById('hfProducto').value =
                document.getElementById('fProducto').value;

            document.getElementById('hfOficina').value =
                document.getElementById('fOficina').value;

            document.getElementById('hfZona').value =
                document.getElementById('fZona').value;

            document.getElementById('hfGerente').value =
                document.getElementById('fGerente').value;
    });


</script>




